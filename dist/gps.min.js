/*
GPS.js v0.8.1 11/14/2025
https://raw.org/article/using-gps-with-node-js-and-javascript/

Copyright (c) 2025, Robert Eisele (https://raw.org/)
Licensed under the MIT license.
*/
'use strict';(function(x){function l(b,a=null){if(!b)return null;const c=new Date;if(a){var d=a.slice(4),e=a.slice(2,4)-1;a=a.slice(0,2);d.length===4?c.setUTCFullYear(+d,+e,+a):c.setUTCFullYear(Number("20"+d),+e,+a)}c.setUTCHours(+b.slice(0,2));c.setUTCMinutes(+b.slice(2,4));c.setUTCSeconds(+b.slice(4,6));e=b.indexOf(".");d=0;e!==-1&&e+1<b.length&&(b=b.slice(e+1),b.length>=3?d=+b.slice(0,3):b.length===2?d=+b*10:b.length===1&&(d=+b*100));c.setUTCMilliseconds(d);return c}function m(b,a){if(b==="")return null;
const c=a==="N"||a==="S"?2:3;return(a==="S"||a==="W"?-1:1)*(parseFloat(b.slice(0,c))+parseFloat(b.slice(c))/60)}function f(b){return b===""?null:parseFloat(b)}function t(b){return b===""?null:parseFloat(b)*1.852}function y(b){switch(b){case 0:return"QZSS";case 1:return"GPS";case 2:return"GLONASS";case 3:return"Galileo";case 4:return"BeiDou";default:return"unknown"}}function q(b){b=b.slice(1,3);switch(b){case "GP":return"GPS";case "GQ":return"QZSS";case "GL":return"GLONASS";case "GA":return"Galileo";
case "GB":return"BeiDou";default:return b}}function z(b){switch(b){case "M":return"manual";case "A":return"automatic";case "":return null}this.error(Error("INVALID GSA MODE: "+b))}function A(b){if(b==="")return null;switch(parseInt(b,10)){case 0:return null;case 1:return"fix";case 2:return"dgps-fix";case 3:return"pps-fix";case 4:return"rtk";case 5:return"rtk-float";case 6:return"estimated";case 7:return"manual";case 8:return"simulated"}this.error(Error("INVALID GGA FIX: "+b))}function B(b){if(b===
"")return null;switch(parseInt(b,10)){case 1:return null;case 2:return"2D";case 3:return"3D"}this.error(Error("INVALID GSA FIX: "+b))}function u(b){switch(b){case "":return null;case "A":return"active";case "V":return"void"}this.error(Error("INVALID RMC/GLL STATUS: "+b))}function r(b){switch(b){case "":return null;case "A":return"autonomous";case "D":return"differential";case "E":return"estimated";case "M":return"manual input";case "S":return"simulated";case "N":return"not valid";case "P":return"precise";
case "R":return"rtk";case "F":return"rtk-float"}this.error(Error("INVALID FAA MODE: "+b))}function v(b,a){if(a==="M"||a==="")return f(b);this.error(Error("Unknown unit: "+a))}function C(b){if(b==null)return"";for(var a="\r\n$*,!\\~\u007f".split(""),c=0;c<a.length;c++)b.indexOf(a[c])!==-1&&this.error(Error("Message may not contain invalid character '"+a[c]+"'"));a="";for(c=0;c<b.length;c++)if(b.charCodeAt(c)!==94)a+=b[c];else{var d=b[c+1],e=b[c+2];d==="^"?(a+="^",c+=1):d&&e&&(d>="0"&&d<="9"||d>="A"&&
d<="F"||d>="a"&&d<="f")&&(e>="0"&&e<="9"||e>="A"&&e<="F"||e>="a"&&e<="f")?(a+=String.fromCharCode(parseInt(d+e,16)),c+=2):a+="^"}return a}function k(){if(!(this instanceof k))return new k;this.events=Object.create(null);this.state={errors:0,processed:0,txtBuffer:{}};this._collectSats=Object.create(null);this._collectActiveSats=Object.create(null);this._lastSeenSat=Object.create(null);this.partial=""}const n=Math.PI/180;k.parsers={GGA:function(b,a){a.length!==16&&a.length!==14&&this.error(Error("Invalid GGA length: "+
b));return{time:l(a[1]),lat:m(a[2],a[3]),lon:m(a[4],a[5]),alt:v(a[9],a[10]),quality:A(a[6]),satellites:f(a[7]),hdop:f(a[8]),geoidal:v(a[11],a[12]),age:a[13]===void 0?null:f(a[13]),stationID:a[14]===void 0?null:f(a[14])}},GSA:function(b,a){a.length!==19&&a.length!==20&&this.error(Error("Invalid GSA length: "+b));b=[];for(var c=3;c<15;c++)a[c]!==""&&b.push(parseInt(a[c],10));c=a.length>19?f(a[18]):null;return{mode:z(a[1]),fix:B(a[2]),satellites:b,pdop:f(a[15]),hdop:f(a[16]),vdop:f(a[17]),systemId:c,
system:c!==null?y(c):"unknown"}},RMC:function(b,a){a.length!==13&&a.length!==14&&a.length!==15&&this.error(Error("Invalid RMC length: "+b));b=l(a[1],a[9]);var c=u(a[2]),d=m(a[3],a[4]),e=m(a[5],a[6]),g=t(a[7]),h=f(a[8]),p=a[10],w=a[11];return{time:b,status:c,lat:d,lon:e,speed:g,track:h,variation:p===""||w===""?null:parseFloat(p)*(w==="W"?-1:1),faa:a.length>13?r(a[12]):null,navStatus:a.length>14?a[13]:null}},VTG:function(b,a){a.length!==10&&a.length!==11&&this.error(Error("Invalid VTG length: "+b));
if(a[2]===""&&a[8]===""&&a[6]==="")return{track:null,trackMagnetic:null,speed:null,faa:null};a[2]!=="T"&&this.error(Error("Invalid VTG track mode: "+b));a[8]==="K"&&a[6]==="N"||this.error(Error("Invalid VTG speed tag: "+b));return{track:f(a[1]),trackMagnetic:a[3]===""?null:f(a[3]),speed:t(a[5]),faa:a.length===11?r(a[9]):null}},GSV:function(b,a){a.length%4===0&&this.error(Error("Invalid GSV length: "+b));const c=[],d=b.slice(1,3);for(let e=4;e<a.length-3;e+=4){const g=f(a[e]),h=f(a[e+3]);c.push({prn:g,
elevation:f(a[e+1]),azimuth:f(a[e+2]),snr:h,status:g!==null?h!==null?"tracking":"in view":null,system:q(b),key:d+g})}return{msgNumber:f(a[2]),msgsTotal:f(a[1]),satsInView:f(a[3]),satellites:c,signalId:a.length%4===2?f(a[a.length-2]):null,system:q(b)}},GLL:function(b,a){a.length!==9&&a.length!==8&&this.error(Error("Invalid GLL length: "+b));return{time:l(a[5]),status:u(a[6]),lat:m(a[1],a[2]),lon:m(a[3],a[4]),faa:a.length===9?r(a[7]):null}},ZDA:function(b,a){return{time:l(a[1],a[2]+a[3]+a[4]),offsetMin:a[5]===
""||a[6]===""?null:parseInt(a[5],10)*60+parseInt(a[6],10)}},GST:function(b,a){a.length!==10&&this.error(Error("Invalid GST length: "+b));return{time:l(a[1]),rms:f(a[2]),ellipseMajor:f(a[3]),ellipseMinor:f(a[4]),ellipseOrientation:f(a[5]),latitudeError:f(a[6]),longitudeError:f(a[7]),heightError:f(a[8])}},HDT:function(b,a){a.length!==4&&this.error(Error("Invalid HDT length: "+b));return{heading:parseFloat(a[1]),trueNorth:a[2]==="T"}},GRS:function(b,a){a.length!==18&&this.error(Error("Invalid GRS length: "+
b));b=[];for(let c=3;c<=14;c++){const d=f(a[c]);d!==null&&b.push(d)}return{time:l(a[1]),mode:f(a[2]),res:b}},GBS:function(b,a){a.length!==10&&a.length!==12&&this.error(Error("Invalid GBS length: "+b));return{time:l(a[1]),errLat:f(a[2]),errLon:f(a[3]),errAlt:f(a[4]),failedSat:f(a[5]),probFailedSat:f(a[6]),biasFailedSat:f(a[7]),stdFailedSat:f(a[8]),systemId:a.length===12?f(a[9]):null,signalId:a.length===12?f(a[10]):null}},GNS:function(b,a){a.length!==14&&a.length!==15&&this.error(Error("Invalid GNS length: "+
b));return{time:l(a[1]),lat:m(a[2],a[3]),lon:m(a[4],a[5]),mode:a[6],satsUsed:f(a[7]),hdop:f(a[8]),alt:f(a[9]),sep:f(a[10]),diffAge:f(a[11]),diffStation:f(a[12]),navStatus:a.length===15?a[13]:null}},TXT:function(b,a){a.length!==6&&this.error(Error("Invalid TXT length: "+b));var c=parseInt(a[1],10),d=parseInt(a[2],10),e=parseInt(a[3],10),g=a[4]||"";c>=1&&c<=99||this.error(Error("Invalid TXT total: "+a[1]));d>=1&&d<=c||this.error(Error("Invalid TXT index: "+a[2]));e>=0&&e<=99||this.error(Error("Invalid TXT id: "+
a[3]));g.length>61&&this.error(Error("Invalid TXT message length: "+g.length));a=C(g);a===""&&this.error(Error("Invalid empty TXT message"));return{total:c,index:d,id:e,part:a,message:c===1?a:null,completed:c===1,rawMessages:c===1?[a]:[],system:q(b)}}};k.Parse=function(b){if(typeof b!=="string"||b.length<6||b.charCodeAt(0)!==36)return!1;var a=b.indexOf("*",1);if(a===-1||a+2>=b.length)return!1;var c=[],d=b.indexOf(",",1);if(d===-1||d>a)return!1;c.push("$"+b.slice(1,d));let e=0;for(var g=1;g<a;g++)e^=
b.charCodeAt(g);d+=1;for(g=d;g<a;g++)b.charCodeAt(g)===44&&(c.push(b.slice(d,g)),d=g+1);c.push(b.slice(d,a));g=b.slice(a+1).trim();a=parseInt(g.slice(0,2),16);if(!(a>=0&&a<=255))return!1;c[0]=c[0].slice(3);d=c[0];const h=k.parsers[d];if(h===void 0)return!1;c.push(g.slice(0,2));c=h(b,c);c.raw=b;c.valid=e===a;c.type=d;return c};k.Heading=function(b,a,c,d){a=(d-a)*n;b*=n;c*=n;d=Math.cos(c);return(Math.atan2(Math.sin(a)*d,Math.cos(b)*Math.sin(c)-Math.sin(b)*d*Math.cos(a))*180/Math.PI+360)%360};k.Distance=
function(b,a,c,d){var e=(c-b)*n*.5;a=(d-a)*n*.5;b*=n;c*=n;e=Math.sin(e);a=Math.sin(a);return 12745.6*Math.asin(Math.sqrt(e*e+Math.cos(b)*Math.cos(c)*a*a))};k.TotalDistance=function(b){if(b.length<2)return 0;let a=0;for(let c=0;c<b.length-1;c++){const d=b[c],e=b[c+1];a+=k.Distance(d.lat,d.lon,e.lat,e.lon)}return a};k.prototype={constructor:k,_updateState:function(b){const a=this.state;if(b.type==="RMC"||b.type==="GGA"||b.type==="GLL"||b.type==="GNS")a.time=b.time,a.lat=b.lat,a.lon=b.lon;b.type==="HDT"&&
(a.heading=b.heading,a.trueNorth=b.trueNorth);b.type==="ZDA"&&(a.time=b.time);b.type==="GGA"&&(a.alt=b.alt);if(b.type==="RMC"||b.type==="VTG")b.speed!=null&&(a.speed=b.speed),b.track!=null&&(a.track=b.track);if(b.type==="GSA"){var c=b.systemId;c!=null&&(this._collectActiveSats[c]=b.satellites);c=[];var d=this._collectActiveSats;for(var e in d)if(Object.prototype.hasOwnProperty.call(d,e)){var g=d[e];for(let h=0,p=g.length;h<p;h++)c.push(g[h])}a.satsActive=c;a.fix=b.fix;a.hdop=b.hdop;a.pdop=b.pdop;
a.vdop=b.vdop}if(b.type==="GSV"){e=Date.now();d=b.satellites;b=this._collectSats;c=this._lastSeenSat;for(let h=0,p=d.length;h<p;h++)g=d[h].key,c[g]=e,b[g]=d[h];d=[];for(const h in b)Object.prototype.hasOwnProperty.call(b,h)&&(e-c[h]<3E3?d.push(b[h]):(delete b[h],delete c[h]));a.satsVisible=d}},_assembleTXT:function(b){if(b.total===1)return b;const a=(b.system||"")+"#"+b.id;let c=this.state.txtBuffer[a];if(!c){c=this.state.txtBuffer[a]={total:b.total,parts:Array(b.total).fill(null),received:0,timer:null};
const e=this;c.timer=setTimeout(function(){e.state.errors++;delete e.state.txtBuffer[a]},1E4)}const d=b.index-1;0<=d&&d<c.total&&(c.parts[d]=b.part,c.received++);c.received===c.total?(clearTimeout(c.timer),delete this.state.txtBuffer[a],b.message=c.parts.join(""),b.completed=!0,b.rawMessages=c.parts):(b.message=null,b.completed=!1,b.rawMessages=[]);return b},update:function(b){b=k.Parse(b);this.state.processed++;if(b===!1)return this.state.errors++,!1;b.type==="TXT"&&this._assembleTXT(b);this._updateState(b);
this.emit("data",b);this.emit(b.type,b);return!0},updatePartial:function(b){for(b&&(this.partial+=b);;){b=this.partial.indexOf("\r\n");var a=this.partial.indexOf("\n");let c=-1;b!==-1?c=b:a!==-1&&(c=a);if(c===-1)break;a=this.partial.slice(0,c);this.partial=this.partial.slice(c+(b===c?2:1));if(a.charAt(0)==="$")try{this.update(a)}catch(d){this.state.errors++,this.error(d)}}},on:function(b,a){const c=this.events[b];c===void 0?this.events[b]=[a]:typeof c==="function"?this.events[b]=[c,a]:this.events[b].push(a);
return this},off:function(b,a){const c=this.events[b];if(c===void 0)return this;if(!a)return delete this.events[b],this;if(typeof c==="function")return c===a&&delete this.events[b],this;for(let d=c.length-1;d>=0;d--)c[d]===a&&c.splice(d,1);c.length===0&&delete this.events[b];return this},emit:function(b,a){b=this.events[b];if(b!==void 0)if(typeof b==="function")b.call(this,a);else for(let c=0,d=b.length;c<d;c++)b[c].call(this,a)},error:function(b){if(this.events.error===void 0)throw b;this.emit("error",
b)}};typeof define==="function"&&define.amd?define([],function(){return k}):typeof exports==="object"?(Object.defineProperty(k,"__esModule",{value:!0}),k["default"]=k,k.GPS=k,module.exports=k):x.GPS=k})(this);
